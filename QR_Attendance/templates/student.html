<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard | QR Attendance</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="container-wide glass-container animate-pop">
        <nav class="navbar">
            <div class="brand"><i class="fas fa-user-graduate"></i> Student Portal</div>
            <div class="nav-links" style="display: flex; align-items: center; gap: 1rem;">
                <!-- Theme Toggle -->
                <button onclick="toggleDarkMode()"
                    style="width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; color: var(--text-color); cursor: pointer; transition: all 0.3s; margin: 0;">
                    <i id="theme-icon" class="fas fa-moon"></i>
                </button>

                <!-- User Profile Badge -->
                <div
                    style="background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(4px); padding: 5px 15px 5px 5px; border-radius: 50px; display: flex; align-items: center; gap: 10px; border: 1px solid rgba(255,255,255,0.4);">
                    <div
                        style="width: 35px; height: 35px; background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <i class="fas fa-user"></i>
                    </div>
                    <span style="font-weight: 600; font-size: 0.95rem; color: var(--text-color);">{{ username }}</span>
                </div>

                <!-- Report Issue Button -->
                <button onclick="openGeneralCorrectionModal()"
                    style="width: auto; background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 99%); border: none; padding: 10px 20px; border-radius: 25px; color: white; font-weight: 600; display: flex; align-items: center; gap: 8px; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 154, 158, 0.3); transition: transform 0.2s;">
                    <i class="fas fa-exclamation-triangle"></i> Report Issue
                </button>

                <!-- Logout Button -->
                <a href="/logout"
                    style="width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #e74c3c; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.2s;"
                    title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </nav>

        <!-- Attendance Overview -->
        <div class="stats-container"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="stat-card">
                <h3>Total Present</h3>
                <p class="stat-num">{{ total_present }}</p>
            </div>
            <div class="stat-card">
                <h3>Total Working Days</h3>
                <p class="stat-num">{{ working_days }}</p>
            </div>
            <div class="stat-card">
                <h3>Semester Days Remaining</h3>
                <p class="stat-num" id="stat-rem-days">{{ total_sem_days - working_days }}</p>
            </div>
            <div class="stat-card">
                <h3>Overall Percentage</h3>
                <div style="display: flex; align-items: center; gap: 15px; justify-content: center;">
                    <p class="stat-num" style="min-width: unset;">{{ percentage }}%</p>
                    <div
                        style="width: 100px; background: rgba(255,255,255,0.3); height: 12px; border-radius: 10px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                        <div
                            style="width: {{ percentage }}%; height: 100%; background: linear-gradient(90deg, #96e6a1 0%, #d4fc79 100%); transition: width 1.5s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 0 10px rgba(150, 230, 161, 0.5);">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Smart Analytics Section -->
        <!-- Smart Analytics Section -->
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 3rem;">

            <!-- Safe Zone Calculator -->
            <div class="glass-container"
                style="max-width: none; padding: 2rem; display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; overflow: hidden;">

                <div
                    style="width: 70px; height: 70px; background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; color: white; margin-bottom: 1rem; box-shadow: 0 4px 15px rgba(161, 140, 209, 0.4);">
                    <i class="fas fa-calculator"></i>
                </div>

                <h3 style="margin-bottom: 0.5rem;">Safe Zone</h3>
                <p style="font-size: 0.9rem; margin-bottom: 1.5rem; color: var(--text-muted);">Predict your attendance
                    future</p>

                <div
                    style="display: flex; align-items: center; gap: 10px; margin-bottom: 1.5rem; background: rgba(255,255,255,0.4); padding: 5px 15px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.5);">
                    <span style="font-weight: 600; font-size: 0.9rem;">Target:</span>
                    <input type="number" id="target_pct" value="75" oninput="calculateSafeZone()"
                        style="width: 60px; padding: 5px; border: none; background: transparent; font-size: 1.1rem; font-weight: bold; text-align: center; color: var(--primary-color); outline: none;">
                    <span style="font-weight: 600;">%</span>
                </div>

                <div id="calc-result"
                    style="width: 100%; padding: 15px; background: rgba(255,255,255,0.6); border-radius: 12px; font-weight: 600; font-size: 1.1rem; min-height: 80px; display: flex; align-items: center; justify-content: center; border-left: 5px solid #a18cd1; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    Calculating...
                </div>
            </div>

            <!-- Calendar View -->
            <div class="glass-container" style="max-width: none; padding: 2rem; position: relative; overflow: hidden;">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div
                            style="width: 40px; height: 40px; background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--text-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <h3 style="margin: 0;">History</h3>
                    </div>

                    <div
                        style="display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.5); padding: 5px; border-radius: 20px;">
                        <button onclick="changeMonth(-1)"
                            style="width: 30px; height: 30px; padding: 0; background: transparent; color: var(--text-color); box-shadow: none; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="month-year"
                            style="font-weight: 600; font-size: 0.9rem; min-width: 100px; text-align: center;"></span>
                        <button onclick="changeMonth(1)"
                            style="width: 30px; height: 30px; padding: 0; background: transparent; color: var(--text-color); box-shadow: none; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <div id="calendar-grid"
                    style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; font-size: 0.85rem;">
                    <!-- Days will be generated here -->
                </div>

                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 1.5rem; font-size: 0.8rem;">
                    <div style="display: flex; align-items: center; gap: 5px;"><span
                            style="width: 10px; height: 10px; background: #2ecc71; border-radius: 50%;"></span> Present
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;"><span
                            style="width: 10px; height: 10px; background: #e74c3c; border-radius: 50%;"></span> Absent
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;"><span
                            style="width: 10px; height: 10px; background: #f1c40f; border-radius: 50%;"></span> Holiday
                    </div>
                </div>
            </div>
        </div>

        <h2>My Attendance History</h2>

        <!-- Pass records to JS for Calendar -->
        <!-- Data for JS -->
        <script id="student-data" type="application/json">
            {
                "totalPresent": {{ total_present }},
                "workingDays": {{ working_days }},
                "totalSemDays": {{ total_sem_days }},
                "holidayDates": {{ holidays | map(attribute='date') | list | tojson }},
                "allRecords": [
                    {% for r in records %}
                    { "date": "{{ r.date }}", "status": "{{ r.status }}" }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ]
            }
        </script>

        <script>
            // Parse data safely
            const rawData = JSON.parse(document.getElementById('student-data').textContent);
            const TOTAL_PRESENT = rawData.totalPresent;
            const TOTAL_DAYS = rawData.workingDays;
            const TOTAL_SEM_DAYS = rawData.totalSemDays;
            const holidayDates = new Set(rawData.holidayDates);
            const allRecordsJson = rawData.allRecords;
        </script>

        <script>
            // Calculator Logic
            function calculateSafeZone() {
                const target = parseFloat(document.getElementById('target_pct').value) || 75;
                const p = TOTAL_PRESENT;
                const t = TOTAL_DAYS;
                const T_SEM = TOTAL_SEM_DAYS;
                const remaining = T_SEM - t;
                const currentPct = (p / t) * 100;

                const resEl = document.getElementById('calc-result');

                if (t === 0) {
                    resEl.innerText = "No working days yet.";
                    return;
                }

                // Logic 1: Can I bunk more?
                // Logic based on SO FAR
                let bunkTxt = "";
                if (currentPct >= target) {
                    const x = Math.floor((p * 100 / target) - t);
                    bunkTxt = `<span style="color: var(--success-color)">Currently safe! You can bunk <b>${x}</b> more days.</span>`;
                } else {
                    const x = Math.ceil((target * t - 100 * p) / (100 - target));
                    bunkTxt = `<span style="color: var(--danger-color)">Currently below target. Need <b>${x}</b> more days to recover.</span>`;
                }

                // Logic 2: Goal for Semester End
                // (P + X) / T_SEM >= Target / 100
                // X = Days needed from REMAINING
                const requiredTotal = Math.ceil((target * T_SEM) / 100);
                const x_needed = Math.max(0, requiredTotal - p);

                let semesterGoalTxt = "";
                if (x_needed > remaining) {
                    semesterGoalTxt = `<br><span style="color: #e74c3c; font-size: 0.85rem; margin-top: 5px; display: block;">⚠️ Warning: Target unreachable (${x_needed} days needed but only ${remaining} left)</span>`;
                } else {
                    semesterGoalTxt = `<br><span style="color: var(--text-color); font-size: 0.85rem; margin-top: 5px; display: block;">To end the semester with ${target}%, you must attend <b>${x_needed}</b> out of the remaining <b>${remaining}</b> days.</span>`;
                }

                resEl.innerHTML = `<div>${bunkTxt}${semesterGoalTxt}</div>`;
            }

            // Calendar Logic
            let currentDate = new Date();

            function renderCalendar() {
                const monthYear = document.getElementById('month-year');
                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = '';

                // Headers (Su Mo Tu...)
                const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                days.forEach(d => {
                    const el = document.createElement('div');
                    el.innerText = d;
                    el.style.fontWeight = 'bold';
                    el.style.paddingBottom = '5px';
                    grid.appendChild(el);
                });

                const y = currentDate.getFullYear();
                const m = currentDate.getMonth();

                monthYear.innerText = new Date(y, m).toLocaleString('default', { month: 'long', year: 'numeric' });

                const firstDay = new Date(y, m, 1).getDay();
                const daysInMonth = new Date(y, m + 1, 0).getDate();

                // Empty slots
                for (let i = 0; i < firstDay; i++) {
                    grid.appendChild(document.createElement('div'));
                }

                // Days
                const presentDates = new Set(allRecordsJson.filter(r => r.status === 'PRESENT').map(r => r.date));
                const absentDates = new Set(allRecordsJson.filter(r => r.status === 'ABSENT').map(r => r.date));

                for (let d = 1; d <= daysInMonth; d++) {
                    const el = document.createElement('div');
                    el.innerText = d;
                    el.style.padding = '8px';
                    el.style.borderRadius = '50%';
                    el.style.margin = '2px';
                    el.style.cursor = 'default';

                    const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                    if (presentDates.has(dateStr)) {
                        el.style.background = '#2ecc71'; // Green
                        el.style.color = 'white';
                        el.title = "Present";
                    } else if (absentDates.has(dateStr)) {
                        el.style.background = '#e74c3c'; // Red
                        el.style.color = 'white';
                        el.title = "Absent";
                    } else if (holidayDates.has(dateStr)) {
                        el.style.background = '#f1c40f'; // Yellow/Gold
                        el.style.color = 'white';
                        el.title = "Holiday";
                    } else if (new Date(dateStr).getDay() === 0) {
                        el.style.background = '#dfe6e9'; // Sunday Grey
                        el.style.color = '#636e72';
                    }

                    // Highlight Today
                    const today = new Date();
                    if (d === today.getDate() && m === today.getMonth() && y === today.getFullYear()) {
                        el.style.border = '2px solid var(--primary-color)';
                    }

                    grid.appendChild(el);
                }
            }

            function changeMonth(delta) {
                currentDate.setMonth(currentDate.getMonth() + delta);
                renderCalendar();
            }

            // Init
            calculateSafeZone();
            renderCalendar();
        </script>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Subject</th>
                        <th>Branch</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in records %}
                    <tr>
                        <td>{{ row.date }}</td>
                        <td>{{ row.time }}</td>
                        <td>{{ row.subject }}</td>
                        <td>{{ row.branch }}</td>
                        <td>
                            {% if row.status == 'PRESENT' %}
                            <span class="status-present"><i class="fas fa-check-circle"></i> Present</span>
                            {% else %}
                            <span class="status-absent"><i class="fas fa-times-circle"></i> Absent</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if row.status == 'ABSENT' %}
                            <button
                                onclick="openCorrectionModal('{{ row.session_id }}', '{{ row.subject }}', '{{ row.date }}')"
                                class="btn-small"
                                style="padding: 5px 10px; font-size: 0.8rem; background: var(--primary-color);">
                                <i class="fas fa-edit"></i> Fix
                            </button>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" style="text-align: center;">No attendance records found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h2 style="margin-top: 3rem;">My Correction Requests</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Submitted</th>
                        <th>Subject</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Admin Comment</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in corrections %}
                    <tr>
                        <td>{{ req.timestamp }}</td>
                        <td>{{ req.subject if req.subject else 'General' }}</td>
                        <td>{{ req.reason }}</td>
                        <td>
                            {% if req.status == 'PENDING' %}
                            <span class="status-tag" style="background: #ffeaa7; color: #d63031;">Pending</span>
                            {% elif req.status == 'APPROVED' %}
                            <span class="status-tag" style="background: #55efc4; color: #00b894;">Approved</span>
                            {% else %}
                            <span class="status-tag" style="background: #ff7675; color: #d63031;">Rejected</span>
                            {% endif %}
                        </td>
                        <td>{{ req.admin_comment or '-' }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: #888;">
                            <i class="fas fa-info-circle"></i> No correction requests submitted yet.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Correction Modal -->
    <div id="correctionModal" class="modal"
        style="display:none; position:fixed; z-index:10001; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
        <div class="glass-container animate-pop"
            style="max-width: 500px; margin: 10% auto; padding: 2.5rem; position: relative;">
            <button onclick="closeCorrectionModal()"
                style="position: absolute; right: 20px; top: 20px; background: transparent; border: none; color: white; cursor: pointer; font-size: 1.5rem;">&times;</button>
            <h2 id="modalTitle" style="margin-bottom: 1.5rem;">Request Correction</h2>
            <form action="/submit_correction" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="session_id" id="modalSessionId">
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem;">Reason for Absence</label>
                    <textarea name="reason" placeholder="e.g., Device battery was dead, network issues, joined late..."
                        required
                        style="width: 100%; height: 100px; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.2); font-family: inherit;"></textarea>
                </div>
                <div class="form-group" style="margin-bottom: 2rem;">
                    <label style="display: block; margin-bottom: 0.5rem;">Upload Proof (Photo/Screenshot)</label>
                    <input type="file" name="proof" accept="image/*" style="width: 100%;">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; padding: 12px;">Submit Request</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openCorrectionModal(sessionId, subject, date) {
            document.getElementById('modalSessionId').value = sessionId || '';
            document.getElementById('modalTitle').innerText = sessionId ? `Correction: ${subject} (${date})` : "Report Attendance Issue";
            document.getElementById('correctionModal').style.display = 'block';
        }
        function openGeneralCorrectionModal() {
            openCorrectionModal('', '', '');
        }
        function closeCorrectionModal() {
            document.getElementById('correctionModal').style.display = 'none';
        }
    </script>
    <script src="{{ url_for('static', filename='backjs.js') }}"></script>
</body>

</html>