<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mark Attendance</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Mobile-optimized scan page */
        @media (max-width: 576px) {
            body {
                padding: 10px !important;
            }

            .glass-container {
                padding: 1.25rem !important;
                margin: 5px;
            }

            h2 {
                font-size: 1.3rem !important;
            }

            .form-group input {
                font-size: 16px !important; /* Prevent iOS zoom */
                padding: 14px !important;
            }

            button[type="submit"] {
                padding: 14px 20px !important;
                font-size: 1rem !important;
            }

            i.fa-3x {
                font-size: 2rem !important;
            }
        }
        
        .location-status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .location-status.getting {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
        }
        .location-status.success {
            background: rgba(40, 167, 69, 0.15);
            color: #28a745;
        }
        .location-status.error {
            background: rgba(255, 107, 107, 0.15);
            color: #dc3545;
        }
    </style>
</head>

<body>
    <div class="glass-container animate-pop">
        <div style="text-align: center;">
            <h2>Mark Attendance</h2>
            {{ if .is_expired }}
            <div style="color: var(--danger-color); font-size: 1.2rem; font-weight: bold; margin: 2rem;">
                <i class="fas fa-times-circle fa-3x"></i><br><br>
                This QR Code has expired.
            </div>
            {{ else }}
            <!-- Check if device already marked for this session -->
            <div id="alreadyMarked" style="display: none; color: var(--danger-color); font-size: 1.1rem; margin: 2rem;">
                <i class="fas fa-ban fa-3x"></i><br><br>
                <strong>Already Submitted!</strong><br>
                <p style="font-size: 0.9rem; margin-top: 10px;">You have already marked attendance from this device for this session.</p>
            </div>

            <div id="attendanceForm">
                <p>Please fill in your details quickly.</p>
                <div style="background: rgba(255,255,255,0.3); padding: 10px; border-radius: 10px; margin-bottom: 1rem;">
                    <strong>{{ .subject }}</strong> ({{ .branch }})
                </div>

                <!-- Location Status -->
                <div id="locationStatus" class="location-status getting">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Getting your location...</span>
                </div>

                <form id="scanForm">
                    <input type="hidden" id="s_subject" value="{{ .subject }}">
                    <input type="hidden" id="s_branch" value="{{ .branch }}">
                    <input type="hidden" id="s_exp" value="{{ .exp }}">
                    <input type="hidden" id="s_latitude" value="">
                    <input type="hidden" id="s_longitude" value="">

                    <div class="form-group">
                        <label>Roll Number</label>
                        <input type="text" id="s_roll" placeholder="Enter Roll No" required>
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="s_name" placeholder="Enter Name" required>
                    </div>

                    <button type="submit" id="submitBtn">Submit Attendance</button>
                </form>
                <p id="msg" style="margin-top: 10px; color: var(--danger-color);"></p>
            </div>
            {{ end }}
        </div>
    </div>

    <script>
        // Location variables
        let userLatitude = 0;
        let userLongitude = 0;
        let locationObtained = false;

        // Generate or get unique device ID
        function getDeviceId() {
            let deviceId = localStorage.getItem('qr_device_id');
            if (!deviceId) {
                deviceId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('qr_device_id', deviceId);
            }
            return deviceId;
        }

        // Check if already submitted for this session
        function hasSubmittedForSession(token) {
            const submitted = JSON.parse(localStorage.getItem('qr_submitted_sessions') || '[]');
            return submitted.includes(token);
        }

        // Mark session as submitted
        function markSessionSubmitted(token) {
            const submitted = JSON.parse(localStorage.getItem('qr_submitted_sessions') || '[]');
            if (!submitted.includes(token)) {
                submitted.push(token);
                localStorage.setItem('qr_submitted_sessions', JSON.stringify(submitted));
            }
        }

        // Get user location
        function getUserLocation() {
            const statusDiv = document.getElementById('locationStatus');
            
            if (!navigator.geolocation) {
                statusDiv.className = 'location-status error';
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Location not supported by your browser</span>';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLatitude = position.coords.latitude;
                    userLongitude = position.coords.longitude;
                    locationObtained = true;
                    
                    document.getElementById('s_latitude').value = userLatitude;
                    document.getElementById('s_longitude').value = userLongitude;
                    
                    statusDiv.className = 'location-status success';
                    statusDiv.innerHTML = '<i class="fas fa-map-marker-alt"></i><span>Location verified</span>';
                },
                (error) => {
                    let errorMsg = 'Could not get location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Location access denied. Please enable location.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Location information unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Location request timed out';
                            break;
                    }
                    statusDiv.className = 'location-status error';
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>' + errorMsg + '</span>';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Get token from URL
        const urlToken = window.location.search.split('token=')[1];

        // Check on page load if already submitted
        if (urlToken && hasSubmittedForSession(urlToken)) {
            document.getElementById('attendanceForm')?.style.setProperty('display', 'none');
            document.getElementById('alreadyMarked')?.style.setProperty('display', 'block');
        } else {
            // Get location when page loads
            getUserLocation();
        }

        document.getElementById('scanForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const msg = document.getElementById('msg');

            btn.disabled = true;
            btn.innerText = "Processing...";
            msg.innerText = "";

            const deviceId = getDeviceId();

            try {
                const res = await fetch('/mark_session_attendance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        roll: document.getElementById('s_roll').value.trim(),
                        name: document.getElementById('s_name').value.trim(),
                        token: urlToken,
                        device_id: deviceId,
                        latitude: userLatitude,
                        longitude: userLongitude
                    })
                });
                const result = await res.json();

                if (result.success) {
                    // Mark this session as submitted locally
                    markSessionSubmitted(urlToken);
                    window.location.href = '/success';
                } else {
                    msg.innerText = result.message;
                    btn.disabled = false;
                    btn.innerText = "Submit Attendance";
                }
            } catch (err) {
                console.error(err);
                msg.innerText = "Network Error. Please try again.";
                btn.disabled = false;
                btn.innerText = "Submit Attendance";
            }
        });
    </script>
</body>

</html>
