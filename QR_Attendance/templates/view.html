<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Attendance | QR Attendance</title>
    <link rel="stylesheet" href="/static/style.css?v=2">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="container-wide glass-container animate-pop">
        <nav class="navbar">
            <div class="brand"><i class="fas fa-table"></i> Attendance Records</div>
            <div class="nav-links">
                <a href="/teacher" data-tooltip="Dashboard"><i class="fas fa-arrow-left"></i></a>
                <a href="/logout" style="color: var(--danger-color);" data-tooltip="Logout"><i
                        class="fas fa-sign-out-alt"></i></a>
            </div>
        </nav>

        <!-- Filter Form -->
        <form action="/view_attendance" method="GET"
            style="display: flex; gap: 10px; margin-bottom: 2rem; flex-wrap: wrap; align-items: flex-end;">
            <div style="flex: 1;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Subject</label>
                <input type="text" name="subject" placeholder="Filter by Subject" value="{{ .f_subject }}">
            </div>
            <div style="flex: 1;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Branch</label>
                <select name="branch">
                    <option value="">All Branches</option>
                    {{ $sel := .f_branch }}
                    <option value="CAI" {{ if eq $sel "CAI" }}selected{{ end }}>CAI</option>
                    <option value="CSM" {{ if eq $sel "CSM" }}selected{{ end }}>CSM</option>
                    <option value="CSD" {{ if eq $sel "CSD" }}selected{{ end }}>CSD</option>
                    <option value="CSE-A" {{ if eq $sel "CSE-A" }}selected{{ end }}>CSE-A</option>
                    <option value="CSE-B" {{ if eq $sel "CSE-B" }}selected{{ end }}>CSE-B</option>
                    <option value="CSE-C" {{ if eq $sel "CSE-C" }}selected{{ end }}>CSE-C</option>
                    <option value="CSE-D" {{ if eq $sel "CSE-D" }}selected{{ end }}>CSE-D</option>
                    <option value="CIVIL" {{ if eq $sel "CIVIL" }}selected{{ end }}>CIVIL</option>
                    <option value="MECH" {{ if eq $sel "MECH" }}selected{{ end }}>MECH</option>
                    <option value="ECE" {{ if eq $sel "ECE" }}selected{{ end }}>ECE</option>
                    <option value="EEE" {{ if eq $sel "EEE" }}selected{{ end }}>EEE</option>
                </select>
            </div>
            <div style="flex: 1;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Date</label>
                <input type="date" name="date" value="{{ .f_date }}">
            </div>
            <button type="submit" style="width: auto; padding: 0 30px;">Filter</button>
            <a href="/view_attendance" style="padding: 12px; color: var(--text-color);">Clear</a>
            <button type="button" id="refresh-btn" onclick="refreshTeacherRecords()" style="width: auto; padding: 12px 20px; background: rgba(102, 126, 234, 0.2); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: var(--text-color); cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-sync-alt"></i> <span id="refresh-text">Refresh</span>
            </button>
        </form>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Roll No</th>
                        <th>Name</th>
                        <th>Subject</th>
                        <th>Branch</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {{ if .records }}
                    {{ range .records }}
                    <tr id="row-{{ .ID }}">
                        <td data-label="Roll No">{{ .Roll }}</td>
                        <td data-label="Name">{{ .Name }}</td>
                        <td data-label="Subject">{{ .Subject }}</td>
                        <td data-label="Branch">{{ .Branch }}</td>
                        <td data-label="Date">{{ .Date }}</td>
                        <td data-label="Time">{{ .Time }}</td>
                        <td data-label="Status">
                            {{ if eq .Status "PRESENT" }}
                            <span class="status-present"><i class="fas fa-check-circle"></i> Present</span>
                            {{ else }}
                            <span class="status-absent"><i class="fas fa-times-circle"></i> Absent</span>
                            {{ end }}
                        </td>
                    </tr>
                    {{ end }}
                    {{ else }}
                    <tr>
                        <td colspan="7" style="text-align: center;">No records found.</td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        {{ if gt .total_pages 1 }}
        <div class="pagination">
            <a href="/view_attendance?page={{ .prev_page }}&subject={{ .f_subject }}&branch={{ .f_branch }}&date={{ .f_date }}"
                class="page-btn {{ if eq .page 1 }}disabled{{ end }}">
                <i class="fas fa-chevron-left"></i> Prev
            </a>

            <!-- simplified pagination for now -->
            <span style="padding: 10px;">Page {{ .page }} of {{ .total_pages }}</span>

            <a href="/view_attendance?page={{ .next_page }}&subject={{ .f_subject }}&branch={{ .f_branch }}&date={{ .f_date }}"
                class="page-btn {{ if eq .page .total_pages }}disabled{{ end }}">
                Next <i class="fas fa-chevron-right"></i>
            </a>
        </div>
        {{ end }}
    </div>

    <script>
        async function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record?')) return;

            try {
                const res = await fetch('/delete_record/' + id, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('row-' + id).remove();
                } else {
                    alert('Failed to delete: ' + data.message);
                }
            } catch (e) {
                alert('Error deleting record');
            }
        }

        async function refreshTeacherRecords() {
            const btn = document.getElementById('refresh-btn');
            const btnText = document.getElementById('refresh-text');
            btn.disabled = true;
            btnText.textContent = 'Refreshing...';

            try {
                // Get current filter values
                const filterForm = document.querySelector('form');
                const formData = new FormData(filterForm);
                const subject = formData.get('subject') || '';
                const branch = formData.get('branch') || '';
                const date = formData.get('date') || '';

                const url = new URL('/teacher/refresh_attendance', window.location.origin);
                if (subject) url.searchParams.append('subject', subject);
                if (branch) url.searchParams.append('branch', branch);
                if (date) url.searchParams.append('date', date);

                const res = await fetch(url.toString());
                const data = await res.json();

                if (data.success && data.records) {
                    // Rebuild table rows
                    const tbody = document.querySelector('table tbody');
                    tbody.innerHTML = '';

                    if (data.records.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No records found.</td></tr>';
                    } else {
                        data.records.forEach(record => {
                            // Handle both lowercase (from JSON) and uppercase field names
                            const status = (record.status || record.Status || 'ABSENT').toUpperCase();
                            const roll = record.roll || record.Roll || '';
                            const name = record.name || record.Name || '';
                            const subject = record.subject || record.Subject || '';
                            const branch = record.branch || record.Branch || '';
                            const date = record.date || record.Date || '';
                            const time = record.time || record.Time || '00:00:00';
                            const id = record.id || record.ID || '';
                            
                            const statusHtml = status === 'PRESENT' 
                                ? '<span class="status-present"><i class="fas fa-check-circle"></i> Present</span>'
                                : '<span class="status-absent"><i class="fas fa-times-circle"></i> Absent</span>';
                            
                            const row = `<tr id="row-${id}">
                                <td data-label="Roll No">${roll}</td>
                                <td data-label="Name">${name}</td>
                                <td data-label="Subject">${subject}</td>
                                <td data-label="Branch">${branch}</td>
                                <td data-label="Date">${date}</td>
                                <td data-label="Time">${time}</td>
                                <td data-label="Status">${statusHtml}</td>
                            </tr>`;
                            tbody.insertAdjacentHTML('beforeend', row);
                        });
                    }
                }
            } catch (e) {
                console.error('Error refreshing:', e);
                alert('Error refreshing records: ' + e.message);
            }

            btn.disabled = false;
            btnText.textContent = 'Refresh';
        }
    </script>
</body>

</html>