<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Attendance | QR Attendance</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="container-wide glass-container animate-pop">
        <nav class="navbar">
            <div class="brand"><i class="fas fa-table"></i> Attendance Records</div>
            <div class="nav-links">
                <a href="/admin" data-tooltip="Dashboard"><i class="fas fa-arrow-left"></i></a>
                <a href="/admin/corrections" data-tooltip="Corrections"><i class="fas fa-clipboard-check"></i></a>
                <a href="/analytics" data-tooltip="Analytics"><i class="fas fa-chart-line"></i></a>
                <a href="/reports" data-tooltip="Reports"><i class="fas fa-file-invoice"></i></a>
                <a href="/logout" style="color: var(--danger-color);" data-tooltip="Logout"><i
                        class="fas fa-sign-out-alt"></i></a>
            </div>
        </nav>

        <!-- Filter Form -->
        <form action="/view_attendance" method="GET"
            style="display: flex; gap: 10px; margin-bottom: 2rem; flex-wrap: wrap;">
            <div style="flex: 1;">
                <input type="text" name="subject" placeholder="Filter by Subject"
                    value="{{ request.args.get('subject', '') }}">
            </div>
            <div style="flex: 1;">
                <select name="branch">
                    <option value="">All Branches</option>
                    <option value="CAI" {% if request.args.get('branch')=='CAI' %}selected{% endif %}>CAI</option>
                    <option value="CSM" {% if request.args.get('branch')=='CSM' %}selected{% endif %}>CSM</option>
                    <option value="CSD" {% if request.args.get('branch')=='CSD' %}selected{% endif %}>CSD</option>
                    <option value="CSE-A" {% if request.args.get('branch')=='CSE-A' %}selected{% endif %}>CSE-A</option>
                    <option value="CSE-B" {% if request.args.get('branch')=='CSE-B' %}selected{% endif %}>CSE-B</option>
                    <option value="CSE-C" {% if request.args.get('branch')=='CSE-C' %}selected{% endif %}>CSE-C</option>
                    <option value="CSE-D" {% if request.args.get('branch')=='CSE-D' %}selected{% endif %}>CSE-D</option>
                    <option value="CIVIL" {% if request.args.get('branch')=='CIVIL' %}selected{% endif %}>CIVIL</option>
                    <option value="MECH" {% if request.args.get('branch')=='MECH' %}selected{% endif %}>MECH</option>
                    <option value="ECE" {% if request.args.get('branch')=='ECE' %}selected{% endif %}>ECE</option>
                    <option value="EEE" {% if request.args.get('branch')=='EEE' %}selected{% endif %}>EEE</option>
                </select>
            </div>
            <div style="flex: 1;">
                <input type="date" name="date" value="{{ request.args.get('date', '') }}">
            </div>
            <button type="submit" style="width: auto; padding: 0 30px;">Filter</button>
            <a href="/view_attendance" style="padding: 12px; color: var(--text-color);">Clear</a>
        </form>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Roll No</th>
                        <th>Name</th>
                        <th>Subject</th>
                        <th>Branch</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        {% if session.role == 'admin' %}
                        <th>Action</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in records %}
                    <tr id="row-{{ row.id }}">
                        <td data-label="Roll No">{{ row.roll }}</td>
                        <td data-label="Name">{{ row.name }}</td>
                        <td data-label="Subject">{{ row.subject }}</td>
                        <td data-label="Branch">{{ row.branch }}</td>
                        <td data-label="Date">{{ row.date }}</td>
                        <td data-label="Time">{{ row.time }}</td>
                        <td data-label="Status">
                            {% if row.status == 'PRESENT' %}
                            <span class="status-present"><i class="fas fa-check-circle"></i> Present</span>
                            {% else %}
                            <span class="status-absent"><i class="fas fa-times-circle"></i> Absent</span>
                            {% endif %}
                        </td>
                        {% if session.role == 'admin' %}
                        <td data-label="Action">
                            <button class="danger" style="padding: 5px 10px; width: auto; font-size: 0.8rem;"
                                onclick="deleteRecord({{ row.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                        {% endif %}
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" style="text-align: center;">No records found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        {% if total_pages > 1 %}
        <div class="pagination">
            <a href="{{ url_for('view_attendance', page=page-1, subject=f_subject, branch=f_branch, date=f_date) }}"
                class="page-btn {% if page == 1 %}disabled{% endif %}">
                <i class="fas fa-chevron-left"></i> Prev
            </a>

            {% for p in range(1, total_pages + 1) %}
            {% if p == 1 or p == total_pages or (p >= page - 1 and p <= page + 1) %} <a
                href="{{ url_for('view_attendance', page=p, subject=f_subject, branch=f_branch, date=f_date) }}"
                class="page-btn {% if p == page %}active{% endif %}">
                {{ p }}
                </a>
                {% elif (p == 2 and page > 3) or (p == total_pages - 1 and page < total_pages - 2) %} <span
                    class="pagination-ellipsis">...</span>
                    {% endif %}
                    {% endfor %}

                    <a href="{{ url_for('view_attendance', page=page+1, subject=f_subject, branch=f_branch, date=f_date) }}"
                        class="page-btn {% if page == total_pages %}disabled{% endif %}">
                        Next <i class="fas fa-chevron-right"></i>
                    </a>
        </div>
        {% endif %}
    </div>

    <script>
        async function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record?')) return;

            try {
                const res = await fetch('/delete_record/' + id, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('row-' + id).remove();
                } else {
                    alert('Failed to delete: ' + data.message);
                }
            } catch (e) {
                alert('Error deleting record');
            }
        }
    </script>
</body>

</html>