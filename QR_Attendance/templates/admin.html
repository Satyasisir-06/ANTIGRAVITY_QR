<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | QR Attendance</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=3">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
</head>

<body>
    <div class="container-wide glass-container animate-pop">
        <nav class="navbar">
            <div class="brand"><span class="pulse-live"></span><i class="fas fa-user-shield"></i> Admin Panel</div>
            <div class="nav-links">
                <button onclick="toggleDarkMode()" class="theme-toggle-btn" data-tooltip="Toggle Theme">
                    <i id="theme-icon" class="fas fa-moon"></i>
                </button>
                <a href="/view_attendance" data-tooltip="View Records"><i class="fas fa-list"></i></a>
                <a href="/admin/corrections" data-tooltip="Corrections"><i class="fas fa-clipboard-check"></i></a>
                <a href="/analytics" data-tooltip="Analytics"><i class="fas fa-chart-line"></i></a>
                <a href="/sms_logs" data-tooltip="SMS Logs"><i class="fas fa-sms"></i></a>
                <a href="/reports" data-tooltip="Reports"><i class="fas fa-file-invoice"></i></a>
                <a href="/settings" data-tooltip="Settings"><i class="fas fa-cogs"></i></a>
                <a href="/export_csv" data-tooltip="Export CSV"><i class="fas fa-file-csv"></i></a>
                <a href="/backup_db" data-tooltip="Backup DB"><i class="fas fa-database"></i></a>
                <a href="/logout" style="color: var(--danger-color);" data-tooltip="Logout"><i
                        class="fas fa-sign-out-alt"></i></a>
            </div>
        </nav>

        <div class="stats-container flex-wrap-center" style="margin-bottom: 2rem;">
            <a href="/class_records?group=CSE" class="stat-card"
                style="text-decoration: none; color: inherit; cursor: pointer; text-align: center; flex: 1; min-width: 120px;">
                <i class="fas fa-laptop-code" style="font-size: 1.5rem; color: #3498db; margin-bottom: 10px;"></i>
                <h3 style="font-size: 0.9rem; margin-bottom: 5px;">CSE <span class="live-badge"><span
                            class="dot"></span>Live</span></h3>
                <p class="stat-num" id="stat-cse" style="font-size: 1.2rem; margin: 0;">{{ cse_count }}</p>
            </a>
            <a href="/class_records?group=ECE" class="stat-card"
                style="text-decoration: none; color: inherit; cursor: pointer; text-align: center; flex: 1; min-width: 120px;">
                <i class="fas fa-microchip" style="font-size: 1.5rem; color: #9b59b6; margin-bottom: 10px;"></i>
                <h3 style="font-size: 0.9rem; margin-bottom: 5px;">ECE <span class="live-badge"><span
                            class="dot"></span>Live</span></h3>
                <p class="stat-num" id="stat-ece" style="font-size: 1.2rem; margin: 0;">{{ ece_count }}</p>
            </a>
            <a href="/class_records?group=EEE" class="stat-card"
                style="text-decoration: none; color: inherit; cursor: pointer; text-align: center; flex: 1; min-width: 120px;">
                <i class="fas fa-bolt" style="font-size: 1.5rem; color: #f1c40f; margin-bottom: 10px;"></i>
                <h3 style="font-size: 0.9rem; margin-bottom: 5px;">EEE <span class="live-badge"><span
                            class="dot"></span>Live</span></h3>
                <p class="stat-num" id="stat-eee" style="font-size: 1.2rem; margin: 0;">{{ eee_count }}</p>
            </a>
            <a href="/class_records?group=MECH" class="stat-card"
                style="text-decoration: none; color: inherit; cursor: pointer; text-align: center; flex: 1; min-width: 120px;">
                <i class="fas fa-cog" style="font-size: 1.5rem; color: #e67e22; margin-bottom: 10px;"></i>
                <h3 style="font-size: 0.9rem; margin-bottom: 5px;">MECH <span class="live-badge"><span
                            class="dot"></span>Live</span></h3>
                <p class="stat-num" id="stat-mech" style="font-size: 1.2rem; margin: 0;">{{ mech_count }}</p>
            </a>
            <a href="/class_records?group=CIVIL" class="stat-card"
                style="text-decoration: none; color: inherit; cursor: pointer; text-align: center; flex: 1; min-width: 120px;">
                <i class="fas fa-city" style="font-size: 1.5rem; color: #e74c3c; margin-bottom: 10px;"></i>
                <h3 style="font-size: 0.9rem; margin-bottom: 5px;">CIVIL <span class="live-badge"><span
                            class="dot"></span>Live</span></h3>
                <p class="stat-num" id="stat-civil" style="font-size: 1.2rem; margin: 0;">{{ civil_count }}</p>
            </a>
        </div>


        <div class="responsive-grid">
            <!-- Timetable Upload Section -->
            <div style="grid-column: 1 / -1; margin-bottom: 2rem;">
                <div class="glass-card">
                    <h2><i class="fas fa-upload"></i> Upload Teacher Timetable</h2>
                    <p style="color: var(--text-muted); margin-bottom: 1rem;">Upload a CSV file to assign subjects to
                        teachers. This will automatically create teacher accounts.</p>

                    <form id="timetableForm" enctype="multipart/form-data" style="margin-bottom: 1rem;">
                        <div style="display: flex; gap: 1rem; align-items: end; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 300px;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Select Timetable
                                    CSV</label>
                                <input type="file" id="timetableFile" accept=".csv" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 2px dashed var(--border-color);">
                            </div>
                            <button type="submit" class="primary" style="width: auto; padding: 0 30px;">
                                <i class="fas fa-cloud-upload-alt"></i> Upload
                            </button>
                        </div>
                    </form>

                    <div id="uploadResult" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;">
                    </div>

                    <details style="margin-top: 1rem; cursor: pointer;">
                        <summary style="font-weight: 600; color: var(--primary-color);">
                            <i class="fas fa-info-circle"></i> CSV Format Example
                        </summary>
                        <div
                            style="margin-top: 1rem; background: rgba(0,0,0,0.05); padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.85rem; overflow-x: auto;">
                            Teacher_ID,Teacher_Name,Email,Subject,Branch,Day,Time_Slot,Semester<br>
                            T001,Dr. John Smith,john@college.edu,Machine
                            Learning,CSE-A,Monday,09:00-10:00,2025-Spring<br>
                            T001,Dr. John Smith,john@college.edu,DBMS,CSE-B,Tuesday,11:00-12:00,2025-Spring<br>
                            T002,Prof. Mary Jane,mary@college.edu,Networks,ECE,Wednesday,10:00-11:00,2025-Spring
                        </div>
                    </details>
                </div>
            </div>

            <!-- Currently Running Classes (Monitoring Only) -->
            <div style="grid-column: 1 / -1; margin-bottom: 2rem;">
                <div class="glass-card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0;"><i class="fas fa-chalkboard-teacher"></i> Currently Running Classes</h2>
                        <span class="live-badge"><span class="dot"></span>Monitoring</span>
                    </div>

                    <!-- Active Sessions Grid (Read-Only) -->
                    <div id="active-sessions-grid"
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                        {% if active_sessions %}
                        {% for s in active_sessions %}
                        <div id="session-card-{{ s.id }}" class="session-card animate-pop">
                            <div
                                style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <h3 style="margin: 0; color: var(--primary-color);">{{ s.subject }}</h3>
                                    <div style="font-size: 0.9rem; color: #666; margin-top: 4px;">
                                        <span style="font-weight: bold;">{{ s.branch }}</span> • {{ s.class_type }}{% if
                                        s.class_type=='Lab' %} (3h){% else %} (1h){% endif %}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.75rem; text-transform: uppercase; color: #888;">Ends In
                                    </div>
                                    <div id="class-timer-{{ s.id }}"
                                        style="font-size: 1.4rem; font-weight: bold; font-family: monospace;">00:00:00
                                    </div>
                                </div>
                            </div>

                            <div class="session-card-content">
                                <div class="qr-container">
                                    <img src="/get_qr_img/{{ s.qr_token }}" id="qr-image-{{ s.id }}"
                                        style="width: 100%; display: block; margin: 0 auto;">
                                    <div
                                        style="font-size: 0.75rem; font-weight: bold; color: var(--danger-color); margin-top: 5px;">
                                        <span id="qr-timer-{{ s.id }}">02:00</span>
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; justify-content: space-between;">
                                    <div style="font-size: 0.85rem; color: #666;">
                                        <i class="fas fa-qrcode"></i> <a href="/scan_session?token={{ s.qr_token }}"
                                            target="_blank" style="color: var(--primary-color);">Open Scan Link</a>
                                    </div>
                                    <button onclick="finalizeAttendance({{ s.id }}, false, this)" class="danger"
                                        style="width: 100%; padding: 8px; font-size: 0.9rem;">
                                        <i class="fas fa-flag-checkered"></i> Finalize
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div id="no-sessions-msg"
                            style="grid-column: 1 / -1; text-align: center; color: #666; padding: 20px;">
                            No active sessions. Start a class to begin.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>


            <div style="grid-column: 1 / -1; margin: 2rem auto 0; max-width: 600px; width: 100%; text-align: center;"
                class="glass-card">
                <!-- Manual Entry Code (Already Present) -->
                <h2><i class="fas fa-edit"></i> Manual Entry</h2>
                <form id="manualForm" onsubmit="manualAttendance(event)">
                    <div class="responsive-grid" style="gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="m_roll" placeholder="Roll No" required>
                        <input type="text" id="m_name" placeholder="Name" required>
                    </div>
                    <div class="responsive-grid" style="gap: 10px;">
                        <input type="text" id="m_subject" placeholder="Subject" required>
                        <select id="m_branch" required>
                            <option value="CAI">CAI</option>
                            <option value="CSM">CSM</option>
                            <option value="CSD">CSD</option>
                            <option value="CSE-A">CSE-A</option>
                            <option value="CSE-B">CSE-B</option>
                            <option value="CSE-C">CSE-C</option>
                            <option value="CSE-D">CSE-D</option>
                            <option value="CIVIL">CIVIL</option>
                            <option value="MECH">MECH</option>
                            <option value="ECE">ECE</option>
                            <option value="EEE">EEE</option>
                        </select>
                    </div>
                    <button type="submit" class="secondary" style="margin-top: 10px;">Mark Present</button>
                    <p id="manualMsg" style="margin-top:5px; text-align: center;"></p>
                </form>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='backjs.js') }}?v=5"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <div id="toast-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;"></div>

    <script>
        const socket = io();

        socket.on('connect', () => {
            console.log("Connected to WebSocket");
        });

        socket.on('new_attendance', (data) => {
            // 1. Show Toast
            showToast(data);

            // 2. Update Stats Counter
            updateStatCounter(data.branch);
        });

        function showToast(data) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'card animate-pop';
            toast.style.background = 'white';
            toast.style.padding = '15px';
            toast.style.marginBottom = '10px';
            toast.style.borderRadius = '10px';
            toast.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
            toast.style.display = 'flex';
            toast.style.alignItems = 'center';
            toast.style.gap = '10px';
            toast.style.minWidth = '250px';
            toast.style.borderLeft = '5px solid #2ecc71';

            toast.innerHTML = `
                <div style="background: #2ecc71; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check"></i>
                </div>
                <div>
                    <div style="font-weight: bold; font-size: 0.9rem;">${data.name}</div>
                    <div style="font-size: 0.8rem; color: #666;">${data.roll} • ${data.branch}</div>
                </div>
            `;

            container.appendChild(toast);

            // Remove after 4 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        function updateStatCounter(branch) {
            // Normalize branch name
            let key = '';
            if (['CAI', 'CSM', 'CSD', 'CSE-A', 'CSE-B', 'CSE-C', 'CSE-D'].includes(branch)) key = 'stat-cse';
            else if (branch === 'ECE') key = 'stat-ece';
            else if (branch === 'EEE') key = 'stat-eee';
            else if (branch === 'MECH') key = 'stat-mech';
            else if (branch === 'CIVIL') key = 'stat-civil';

            if (key) {
                const el = document.getElementById(key);
                if (el) {
                    let current = parseInt(el.textContent);
                    el.textContent = current + 1;

                    // Flash effect
                    el.style.color = '#2ecc71';
                    setTimeout(() => el.style.color = '', 500);
                }
            }
        }
    </script>

    <script id="active-sessions-data" type="application/json">
        {
            "server_now": {{ server_now }},
            "sessions": [
                {% for s in active_sessions %}
                {"id": {{ s.id }}, "subject": "{{ s.subject }}", "end_time": "{{ s.end_time }}", "start_timestamp": {{ s.start_timestamp }}, "end_timestamp": {{ s.end_timestamp }}, "date": "{{ s.date }}", "start_time": "{{ s.start_time }}" }{% if not loop.last %},{% endif %}
                {% endfor %}
            ]
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dataWrap = JSON.parse(document.getElementById('active-sessions-data').textContent);
            const sessions = dataWrap.sessions;
            const serverNow = dataWrap.server_now * 1000;
            const localArrival = Date.now();

            // Set the global offset defined in backjs.js
            window.serverClockOffset = serverNow - localArrival;

            sessions.forEach(s => {
                startClassTimer(s.id, s.end_timestamp, s.subject);

                // Adjust current time for server offset
                const offset = window.serverClockOffset || 0;
                const adjustedNow = Date.now() + offset;
                const startDt = s.start_timestamp * 1000;

                const diffSec = Math.floor((adjustedNow - startDt) / 1000);
                const remaining = 120 - diffSec;

                if (remaining > 0) {
                    startQRTimer(s.id, remaining);
                } else {
                    const qrTimerDisplay = document.getElementById(`qr-timer-${s.id}`);
                    const qrImg = document.getElementById(`qr-image-${s.id}`);
                    if (qrTimerDisplay) {
                        qrTimerDisplay.textContent = "EXPIRED";
                        qrTimerDisplay.style.color = "red";
                    }
                    if (qrImg) qrImg.style.opacity = "0.2";
                }
            });
        });

        // Timetable Upload Handler
        document.getElementById('timetableForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const fileInput = document.getElementById('timetableFile');
            const resultDiv = document.getElementById('uploadResult');
            const submitBtn = e.target.querySelector('button[type="submit"]');

            if (!fileInput.files.length) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = 'rgba(231, 76, 60, 0.1)';
                resultDiv.style.color = '#e74c3c';
                resultDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please select a file';
                return;
            }

            const formData = new FormData();
            formData.append('timetable_file', fileInput.files[0]);

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            resultDiv.style.display = 'block';
            resultDiv.style.background = 'rgba(52, 152, 219, 0.1)';
            resultDiv.style.color = '#3498db';
            resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing CSV file...';

            try {
                const response = await fetch('/admin/upload_timetable', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.style.background = 'rgba(46, 204, 113, 0.1)';
                    resultDiv.style.color = '#2ecc71';
                    resultDiv.innerHTML = '<i class="fas fa-check-circle"></i> ' + data.message +
                        (data.details ? '<div style="margin-top: 0.5rem; font-size: 0.9rem;"><strong>Details:</strong><br>• Teachers added: ' +
                            data.details.teachers_added + '<br>• Teachers updated: ' + data.details.teachers_updated +
                            '<br>• Subject assignments: ' + data.details.subjects_added + '</div>' : '');
                    fileInput.value = '';
                } else {
                    resultDiv.style.background = 'rgba(231, 76, 60, 0.1)';
                    resultDiv.style.color = '#e74c3c';
                    resultDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error: ' + data.message;
                }
            } catch (error) {
                resultDiv.style.background = 'rgba(231, 76, 60, 0.1)';
                resultDiv.style.color = '#e74c3c';
                resultDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Network error';
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload';
            }
        });
    </script>
</body>

</html>