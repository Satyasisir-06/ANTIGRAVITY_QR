<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#a18cd1">
    <meta name="description" content="Admin Dashboard - QR Attendance System">
    <title>Admin Dashboard | QR Attendance</title>

    <!-- Critical CSS first -->
    <link rel="stylesheet" href="/static/style.css?v=3">
    <link rel="stylesheet" href="/static/performance.css">

    <!-- Defer non-critical CSS -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Preload critical resources -->
    <link rel="preload" href="/static/backjs.js" as="script">
    <link rel="preload" href="/static/performance.js" as="script">

    <link rel="manifest" href="/static/manifest.json">
    <style>
        /* Custom scrollbar for running classes */
        #active-sessions-grid::-webkit-scrollbar {
            width: 8px;
        }

        #active-sessions-grid::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        #active-sessions-grid::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            border-radius: 10px;
        }

        #active-sessions-grid::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #8e7cc3 0%, #e9a8d2 100%);
        }

        /* Mobile Responsive Styles for Admin */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 12px;
                padding: 12px 0;
            }

            .navbar .brand {
                font-size: 1rem;
            }

            .nav-links {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px !important;
                width: 100%;
            }

            .nav-links a,
            .nav-links button {
                width: 40px !important;
                height: 40px !important;
                padding: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                border-radius: 10px !important;
                font-size: 1rem !important;
            }

            /* Stats container 3-column on tablet */
            .stats-container {
                justify-content: center !important;
            }

            .stat-card {
                min-width: 100px !important;
                padding: 10px !important;
            }

            .stat-card h3 {
                font-size: 0.75rem !important;
            }

            .stat-num {
                font-size: 1.1rem !important;
            }
        }

        @media (max-width: 576px) {
            body {
                padding: 10px !important;
            }

            .glass-container {
                padding: 1rem !important;
            }

            /* Stats 2-column grid */
            .stats-container {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 8px !important;
            }

            .stat-card {
                min-width: 0 !important;
                padding: 8px !important;
            }

            .stat-card i {
                font-size: 1.2rem !important;
                margin-bottom: 5px !important;
            }

            .stat-card h3 {
                font-size: 0.65rem !important;
                line-height: 1.2;
            }

            .stat-num {
                font-size: 1rem !important;
            }

            .live-badge {
                font-size: 0.5rem !important;
                padding: 1px 4px !important;
            }

            /* Glass card sections */
            .glass-card {
                padding: 1rem !important;
            }

            .glass-card h2 {
                font-size: 1rem !important;
                flex-wrap: wrap;
                gap: 8px;
            }

            /* Running class cards */
            .running-class-card {
                padding: 0.75rem !important;
            }

            .running-class-card h3 {
                font-size: 0.95rem !important;
            }

            /* Teacher Management Table */
            table {
                font-size: 0.8rem !important;
            }

            table th,
            table td {
                padding: 8px 6px !important;
            }

            /* Form inputs */
            input[type="text"],
            input[type="email"],
            input[type="password"] {
                font-size: 16px !important;
                /* Prevent iOS zoom */
                padding: 12px !important;
            }

            /* Responsive grid */
            .responsive-grid {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            /* Action buttons */
            button.secondary {
                padding: 8px 12px !important;
                font-size: 0.75rem !important;
            }

            /* Session timer */
            #active-sessions-grid [id^="timer-"] {
                font-size: 1rem !important;
            }

            /* Form section */
            #createTeacherForm {
                padding: 1rem !important;
            }

            #createTeacherForm h2 {
                font-size: 1.1rem !important;
            }
        }

        @media (max-width: 360px) {
            .stats-container {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .stat-card h3 {
                font-size: 0.6rem !important;
            }

            .stat-num {
                font-size: 0.9rem !important;
            }

            .navbar .brand {
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <div class="container-wide glass-container animate-pop">
        <nav class="navbar">
            <div class="brand"><span class="pulse-live"></span><i class="fas fa-user-shield"></i> Admin Panel</div>
            <div class="nav-links">
                <button onclick="toggleDarkMode()" class="theme-toggle-btn" data-tooltip="Toggle Theme">
                    <i id="theme-icon" class="fas fa-moon"></i>
                </button>
                <a href="/admin/corrections" data-tooltip="Corrections"><i class="fas fa-clipboard-check"></i></a>
                <a href="/admin/teacher-attendance" data-tooltip="Teacher Attendance"><i
                        class="fas fa-chalkboard-teacher"></i></a>
                <a href="/analytics" data-tooltip="Analytics"><i class="fas fa-chart-line"></i></a>
                <a href="/reports" data-tooltip="Reports"><i class="fas fa-file-invoice"></i></a>
                <a href="/settings" data-tooltip="Settings"><i class="fas fa-cogs"></i></a>
                <a href="/export_csv" data-tooltip="Export CSV"><i class="fas fa-file-csv"></i></a>
                <a href="/backup_db" data-tooltip="Backup DB"><i class="fas fa-database"></i></a>
                <a href="/logout" style="color: var(--danger-color);" data-tooltip="Logout"><i
                        class="fas fa-sign-out-alt"></i></a>
            </div>
        </nav>

        <div class="stats-container flex-wrap-center" style="margin-bottom: 2rem;">
            <a href="/class_records?group=CSE" class="stat-card"
                style="text-decoration: none; color: inherit; cursor: pointer; text-align: center; flex: 1; min-width: 120px;">
                <i class="fas fa-laptop-code" style="font-size: 1.5rem; color: #3498db; margin-bottom: 10px;"></i>
                <h3 style="font-size: 0.9rem; margin-bottom: 5px;">CSE <span class="live-badge"><span
                            class="dot"></span>Live</span></h3>
                <p class="stat-num" id="stat-cse" style="font-size: 1.2rem; margin: 0;">{{ .cse_count }}</p>
            </a>
            <a href="/class_records?group=AI" class="stat-card"
                style="text-decoration: none; color: inherit; cursor: pointer; text-align: center; flex: 1; min-width: 120px;">
                <i class="fas fa-robot" style="font-size: 1.5rem; color: #00d2d3; margin-bottom: 10px;"></i>
                <h3 style="font-size: 0.9rem; margin-bottom: 5px;">AI <span class="live-badge"><span
                            class="dot"></span>Live</span></h3>
                <p class="stat-num" id="stat-ai" style="font-size: 1.2rem; margin: 0;">{{ .ai_count }}</p>
            </a>
            <a href="/class_records?group=ECE" class="stat-card"
                style="text-decoration: none; color: inherit; cursor: pointer; text-align: center; flex: 1; min-width: 120px;">
                <i class="fas fa-microchip" style="font-size: 1.5rem; color: #9b59b6; margin-bottom: 10px;"></i>
                <h3 style="font-size: 0.9rem; margin-bottom: 5px;">ECE <span class="live-badge"><span
                            class="dot"></span>Live</span></h3>
                <p class="stat-num" id="stat-ece" style="font-size: 1.2rem; margin: 0;">{{ .ece_count }}</p>
            </a>
            <a href="/class_records?group=EEE" class="stat-card"
                style="text-decoration: none; color: inherit; cursor: pointer; text-align: center; flex: 1; min-width: 120px;">
                <i class="fas fa-bolt" style="font-size: 1.5rem; color: #f1c40f; margin-bottom: 10px;"></i>
                <h3 style="font-size: 0.9rem; margin-bottom: 5px;">EEE <span class="live-badge"><span
                            class="dot"></span>Live</span></h3>
                <p class="stat-num" id="stat-eee" style="font-size: 1.2rem; margin: 0;">{{ .eee_count }}</p>
            </a>
            <a href="/class_records?group=MECH" class="stat-card"
                style="text-decoration: none; color: inherit; cursor: pointer; text-align: center; flex: 1; min-width: 120px;">
                <i class="fas fa-cog" style="font-size: 1.5rem; color: #e67e22; margin-bottom: 10px;"></i>
                <h3 style="font-size: 0.9rem; margin-bottom: 5px;">MECH <span class="live-badge"><span
                            class="dot"></span>Live</span></h3>
                <p class="stat-num" id="stat-mech" style="font-size: 1.2rem; margin: 0;">{{ .mech_count }}</p>
            </a>
            <a href="/class_records?group=CIVIL" class="stat-card"
                style="text-decoration: none; color: inherit; cursor: pointer; text-align: center; flex: 1; min-width: 120px;">
                <i class="fas fa-city" style="font-size: 1.5rem; color: #e74c3c; margin-bottom: 10px;"></i>
                <h3 style="font-size: 0.9rem; margin-bottom: 5px;">CIVIL <span class="live-badge"><span
                            class="dot"></span>Live</span></h3>
                <p class="stat-num" id="stat-civil" style="font-size: 1.2rem; margin: 0;">{{ .civil_count }}</p>
            </a>
        </div>


        <div class="responsive-grid">
            <!-- Currently Running Classes (Monitoring Only) -->
            <div style="grid-column: 1 / -1; margin-bottom: 2rem;">
                <div class="glass-card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0;"><i class="fas fa-chalkboard-teacher"></i> Currently Running Classes</h2>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span style="font-size: 0.9rem; color: var(--text-muted);">
                                <strong id="active-count">{{ len .active_sessions }}</strong> Active Sessions
                            </span>
                            <span class="live-badge"><span class="dot"></span>Live</span>
                        </div>
                    </div>

                    <!-- Active Sessions Grid with Scroll -->
                    <div id="active-sessions-grid" style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                        {{ if .active_sessions }}
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem;">
                            {{ range $s := .active_sessions }}
                            <div class="running-class-card"
                                style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.08), rgba(39, 174, 96, 0.03)); border: 1px solid rgba(46, 204, 113, 0.3); border-left: 4px solid #2ecc71; border-radius: 12px; padding: 1rem; position: relative; overflow: hidden;">
                                <!-- Live indicator -->
                                <div style="position: absolute; top: 10px; right: 10px;">
                                    <span
                                        style="display: inline-flex; align-items: center; gap: 5px; font-size: 0.7rem; background: rgba(46, 204, 113, 0.2); color: #27ae60; padding: 3px 8px; border-radius: 10px; font-weight: 600;">
                                        <span
                                            style="width: 6px; height: 6px; background: #2ecc71; border-radius: 50%; animation: blink 1s infinite;"></span>
                                        LIVE
                                    </span>
                                </div>

                                <!-- Branch Badge -->
                                <div
                                    style="display: inline-block; background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.75rem; font-weight: 700; margin-bottom: 10px;">
                                    {{ $s.Branch }}
                                </div>

                                <!-- Subject -->
                                <h3 style="margin: 0 0 8px 0; font-size: 1.1rem; color: var(--text-color);">{{
                                    $s.Subject }}</h3>

                                <!-- Teacher Info -->
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                    <div
                                        style="width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem;">
                                        <i class="fas fa-user-tie"></i>
                                    </div>
                                    <span style="font-size: 0.9rem; color: var(--text-muted);">{{ $s.TeacherName
                                        }}</span>
                                </div>

                                <!-- Class Details -->
                                <div
                                    style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">
                                    <span><i class="fas fa-clock" style="color: #3498db;"></i> Started: {{ $s.Time
                                        }}</span>
                                    <span><i class="fas fa-tag" style="color: #9b59b6;"></i> {{ $s.ClassType }}{{ if eq
                                        $s.ClassType "Lab" }} (3hrs){{ else }} (1hr){{ end }}</span>
                                </div>

                                <!-- Timer & Actions -->
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.05);">
                                    <div>
                                        <span style="font-size: 0.7rem; color: #888; text-transform: uppercase;">Ends
                                            In</span>
                                        <div id="timer-{{ $s.ID }}"
                                            style="font-size: 1.2rem; font-weight: 700; font-family: monospace; color: #e74c3c;"
                                            data-end="{{ printf " %.0f" $s.EndTime }}">--:--:--</div>
                                    </div>
                                    <form method="POST" action="/teacher/finalize_session" style="margin: 0;">
                                        <input type="hidden" name="session_id" value="{{ $s.ID }}">
                                        <button type="submit"
                                            style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 500; cursor: pointer;">
                                            <i class="fas fa-stop"></i> End Session
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {{ end }}
                        </div>
                        {{ else }}
                        <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            <i class="fas fa-chalkboard"
                                style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                            <p style="margin: 0; font-size: 1rem;">No classes running at the moment</p>
                            <p style="margin: 5px 0 0; font-size: 0.85rem; opacity: 0.7;">Teachers can start sessions
                                from their dashboard</p>
                        </div>
                        {{ end }}
                    </div>
                </div>
            </div>


            <!-- Teacher Management Section -->
            <div style="grid-column: 1 / -1; margin: 2rem auto 0; max-width: 1200px; width: 100%;">
                <div class="glass-card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin: 0;"><i class="fas fa-chalkboard-teacher"></i> Teacher Management</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <a href="/admin/timetable-page" class="secondary"
                                style="width: auto; padding: 5px 15px; font-size: 0.8rem; text-decoration: none; display: inline-flex; align-items: center; gap: 5px;">
                                <i class="fas fa-calendar-alt"></i> Timetable
                            </a>
                            <a href="/admin/teacher-attendance" class="secondary" id="pendingRegLink"
                                style="width: auto; padding: 5px 15px; font-size: 0.8rem; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; background: rgba(243, 156, 18, 0.2); border-color: #f39c12;">
                                <i class="fas fa-user-clock"></i> Pending Registrations
                                <span id="pendingRegBadge"
                                    style="background: #f39c12; color: white; border-radius: 10px; padding: 2px 8px; font-size: 0.7rem; display: none;"></span>
                            </a>
                            <button onclick="loadTeachers()" class="secondary"
                                style="width: auto; padding: 5px 15px; font-size: 0.8rem;">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div style="margin-top: 1rem; max-height: 400px; overflow-y: auto; overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                            <thead>
                                <tr
                                    style="background: rgba(161, 140, 209, 0.1); border-bottom: 2px solid var(--border-color);">
                                    <th style="padding: 12px; text-align: left;">Teacher ID</th>
                                    <th style="padding: 12px; text-align: left;">Name</th>
                                    <th style="padding: 12px; text-align: left;">Email</th>
                                    <th style="padding: 12px; text-align: center;">Subjects</th>
                                    <th style="padding: 12px; text-align: center;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="teachersList">
                                <tr>
                                    <td colspan="5" style="padding: 20px; text-align: center; color: #666;">
                                        <i class="fas fa-spinner fa-spin"></i> Loading teachers...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Teacher Attendance Record (Session History) -->
            <div style="grid-column: 1 / -1; margin: 2rem auto 0; max-width: 1200px; width: 100%;">
                <div class="glass-card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="margin: 0;"><i class="fas fa-history"></i> Teacher Attendance Record</h2>
                        <button onclick="loadTeacherHistory()" class="secondary"
                            style="width: auto; padding: 5px 15px; font-size: 0.8rem;">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>

                    <div style="margin-top: 1rem; max-height: 400px; overflow-y: auto; overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; min-width: 700px;">
                            <thead>
                                <tr
                                    style="background: rgba(161, 140, 209, 0.1); border-bottom: 2px solid var(--border-color);">
                                    <th style="padding: 12px; text-align: left;">Date & Time</th>
                                    <th style="padding: 12px; text-align: left;">Teacher</th>
                                    <th style="padding: 12px; text-align: left;">Subject</th>
                                    <th style="padding: 12px; text-align: left;">Branch</th>
                                    <th style="padding: 12px; text-align: center;">Students</th>
                                    <th style="padding: 12px; text-align: center;">Type</th>
                                </tr>
                            </thead>
                            <tbody id="teacherHistoryList">
                                <tr>
                                    <td colspan="6" style="padding: 20px; text-align: center; color: #666;">
                                        <i class="fas fa-spinner fa-spin"></i> Loading records...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div style="grid-column: 1 / -1; margin: 2rem auto 0; max-width: 600px; width: 100%; text-align: center;"
                class="glass-card">
                <h2><i class="fas fa-user-plus"></i> Manual Teacher Registration</h2>
                <form id="createTeacherForm" onsubmit="createTeacherManual(event)">
                    <div class="responsive-grid" style="gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="t_id" placeholder="Teacher ID (e.g. T001)" required>
                        <input type="text" id="t_name" placeholder="Full Name" required>
                    </div>
                    <div class="responsive-grid" style="gap: 10px;">
                        <input type="email" id="t_email" placeholder="Email (Optional)">
                        <input type="password" id="t_password" placeholder="Password" required>
                    </div>
                    <button type="submit" class="primary" style="margin-top: 10px; width: 100%;">Create Teacher
                        Account</button>
                    <p id="teacherMsg" style="margin-top:5px; text-align: center;"></p>
                </form>
            </div>

        </div>
    </div>

    <script src="/static/backjs.js?v=5" defer></script>
    <script src="/static/performance.js" defer></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js" defer></script>
    <div id="toast-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;"></div>

    <script>
        const socket = io();

        socket.on('connect', () => {
            console.log("Connected to WebSocket");
        });

        socket.on('new_attendance', (data) => {
            // 1. Show Toast
            showToast(data);

            // 2. Update Stats Counter
            updateStatCounter(data.branch);
        });

        function showToast(data) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'card animate-pop';
            toast.style.background = 'white';
            toast.style.padding = '15px';
            toast.style.marginBottom = '10px';
            toast.style.borderRadius = '10px';
            toast.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
            toast.style.display = 'flex';
            toast.style.alignItems = 'center';
            toast.style.gap = '10px';
            toast.style.minWidth = '250px';
            toast.style.borderLeft = '5px solid #2ecc71';

            toast.innerHTML = `
                <div style="background: #2ecc71; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check"></i>
                </div>
                <div>
                    <div style="font-weight: bold; font-size: 0.9rem;">${data.name}</div>
                    <div style="font-size: 0.8rem; color: #666;">${data.roll} • ${data.branch}</div>
                </div>
            `;

            container.appendChild(toast);

            // Remove after 4 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        function updateStatCounter(branch) {
            // Normalize branch name
            let key = '';
            if (['CSE-A', 'CSE-B', 'CSE-C', 'CSE-D'].includes(branch)) key = 'stat-cse';
            else if (['CAI', 'CSM', 'CSD'].includes(branch)) key = 'stat-ai';
            else if (['ECE', 'ECE-A', 'ECE-B'].includes(branch)) key = 'stat-ece';
            else if (['EEE', 'EEE-A', 'EEE-B'].includes(branch)) key = 'stat-eee';
            else if (['MECH', 'MECH-A', 'MECH-B'].includes(branch)) key = 'stat-mech';
            else if (['CIVIL', 'CIVIL-A', 'CIVIL-B'].includes(branch)) key = 'stat-civil';

            if (key) {
                const el = document.getElementById(key);
                if (el) {
                    let current = parseInt(el.textContent);
                    el.textContent = current + 1;

                    // Flash effect
                    el.style.color = '#2ecc71';
                    setTimeout(() => el.style.color = '', 500);
                }
            }
        }
    </script>

    <script id="active-sessions-data" type="application/json">
        {
            "server_now": {{ .server_now }},
            "sessions": [
                {{ $last := len .active_sessions }}{{ range $i, $s := .active_sessions }}{{ if $i }},{{ end }}
                {"id": "{{ $s.ID }}", "subject": "{{ $s.Subject }}", "end_time": {{ printf "%.0f" $s.EndTime }}, "start_timestamp": {{ printf "%.0f" $s.StartTimestamp }}, "end_timestamp": {{ printf "%.0f" $s.EndTime }}, "date": "{{ $s.Date }}", "start_time": "{{ $s.Time }}" }{{ end }}
            ]
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dataWrap = JSON.parse(document.getElementById('active-sessions-data').textContent);
            const sessions = dataWrap.sessions;
            const serverNow = dataWrap.server_now * 1000;
            const localArrival = Date.now();

            // Set the global offset defined in backjs.js
            window.serverClockOffset = serverNow - localArrival;

            sessions.forEach(s => {
                startClassTimer(s.id, s.end_timestamp, s.subject);

                // Adjust current time for server offset
                const offset = window.serverClockOffset || 0;
                const adjustedNow = Date.now() + offset;
                const startDt = s.start_timestamp * 1000;

                const diffSec = Math.floor((adjustedNow - startDt) / 1000);
                const remaining = 120 - diffSec;

                if (remaining > 0) {
                    startQRTimer(s.id, remaining);
                } else {
                    const qrTimerDisplay = document.getElementById(`qr-timer-${s.id}`);
                    const qrImg = document.getElementById(`qr-image-${s.id}`);
                    if (qrTimerDisplay) {
                        qrTimerDisplay.textContent = "EXPIRED";
                        qrTimerDisplay.style.color = "red";
                    }
                    if (qrImg) qrImg.style.opacity = "0.2";
                }
            });

            // Load teachers and history on page load
            loadTeachers();
            loadTeacherHistory();
            loadPendingCount();
        });

        // Load pending registrations count
        async function loadPendingCount() {
            try {
                const res = await fetch('/admin/pending-teachers');
                const data = await res.json();
                if (data.success && data.pending && data.pending.length > 0) {
                    const badge = document.getElementById('pendingRegBadge');
                    if (badge) {
                        badge.textContent = data.pending.length;
                        badge.style.display = 'inline';
                    }
                }
            } catch (e) { }
        }

        // Load Teachers List
        async function loadTeachers() {
            const listBody = document.getElementById('teachersList');
            try {
                const res = await fetch('/admin/get_teachers');
                const data = await res.json();

                if (data.success && data.teachers.length > 0) {
                    listBody.innerHTML = '';
                    data.teachers.forEach(t => {
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid var(--border-color)';
                        tr.innerHTML = `
                            <td style="padding: 12px; font-family: monospace;">${t.teacher_id}</td>
                            <td style="padding: 12px; font-weight: 600;">${t.name}</td>
                            <td style="padding: 12px; color: var(--text-muted);">${t.email || '-'}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span class="stat-badge" style="background: rgba(161, 140, 209, 0.2); color: #a18cd1; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem;">
                                    ${t.subject_count} Subjects
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="display: inline-flex; align-items: center; gap: 5px;">
                                    <span style="width: 10px; height: 10px; background: #2ecc71; border-radius: 50%;"></span>
                                    Active
                                </span>
                            </td>
                        `;
                        listBody.appendChild(tr);
                    });
                } else if (data.teachers && data.teachers.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #666;"><i class="fas fa-user-slash"></i> No teachers registered yet.</td></tr>';
                } else {
                    listBody.innerHTML = `<tr><td colspan="5" style="padding: 20px; text-align: center; color: #e74c3c;">Error: ${data.message}</td></tr>`;
                }
            } catch (err) {
                listBody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #e74c3c;"><i class="fas fa-exclamation-triangle"></i> Failed to load teachers list.</td></tr>';
            }
        }

        // Load Teacher Session History (Attendance Record)
        async function loadTeacherHistory() {
            const listBody = document.getElementById('teacherHistoryList');
            if (!listBody) return;
            try {
                const res = await fetch('/admin/teacher_session_history');
                const data = await res.json();

                if (data.success && data.history.length > 0) {
                    listBody.innerHTML = '';
                    data.history.forEach(s => {
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid var(--border-color)';
                        tr.innerHTML = `
                            <td style="padding: 12px;">
                                <div style="font-weight: 600;">${s.date}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${s.start_time} - ${s.end_time}</div>
                            </td>
                            <td style="padding: 12px; font-weight: 600; color: var(--primary-color);">${s.teacher_name || 'Unknown'}</td>
                            <td style="padding: 12px;">${s.subject}</td>
                            <td style="padding: 12px;">${s.branch}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span class="stat-badge" style="background: rgba(46, 204, 113, 0.1); color: #2ecc71; border-radius: 4px; padding: 2px 8px;">
                                    ${s.student_count} Present
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="font-size: 0.85rem; background: ${s.class_type === 'Lab' ? 'rgba(155, 89, 182, 0.1)' : 'rgba(52, 152, 219, 0.1)'}; color: ${s.class_type === 'Lab' ? '#9b59b6' : '#3498db'}; padding: 2px 8px; border-radius: 4px;">
                                    ${s.class_type}
                                </span>
                            </td>
                        `;
                        listBody.appendChild(tr);
                    });
                } else if (data.history && data.history.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #666;"><i class="fas fa-calendar-times"></i> No teacher sessions recorded yet.</td></tr>';
                } else {
                    listBody.innerHTML = `<tr><td colspan="6" style="padding: 20px; text-align: center; color: #e74c3c;">Error: ${data.message}</td></tr>`;
                }
            } catch (err) {
                listBody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #e74c3c;"><i class="fas fa-exclamation-triangle"></i> Failed to load session history.</td></tr>';
            }
        }

        // Create Teacher Manual
        async function createTeacherManual(e) {
            e.preventDefault();

            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            const msg = document.getElementById('teacherMsg');

            const teacher_id = document.getElementById('t_id').value;
            const name = document.getElementById('t_name').value;
            const email = document.getElementById('t_email').value;
            const password = document.getElementById('t_password').value;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            msg.innerText = '';

            try {
                const res = await fetch('/admin/create_teacher', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ teacher_id, name, email, password })
                });

                const data = await res.json();

                if (data.success) {
                    msg.style.color = '#2ecc71';
                    msg.innerText = '✓ ' + data.message;
                    e.target.reset();
                    loadTeachers(); // Refresh list
                } else {
                    msg.style.color = '#e74c3c';
                    msg.innerText = 'Error: ' + data.message;
                }
            } catch (err) {
                msg.style.color = '#e74c3c';
                msg.innerText = 'Network Error';
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Session countdown timers - uses server time offset for accuracy
        function updateSessionTimers() {
            // Use server clock offset for accurate timing
            const offset = window.serverClockOffset || 0;
            const now = Math.floor((Date.now() + offset) / 1000);

            document.querySelectorAll('[id^="timer-"]').forEach(el => {
                const endTime = parseInt(el.dataset.end, 10);
                if (!endTime || isNaN(endTime)) {
                    el.textContent = '--:--:--';
                    return;
                }

                const remaining = endTime - now;

                if (remaining <= 0) {
                    el.textContent = 'ENDED';
                    el.style.color = '#95a5a6';

                    // Find and remove the session card after a short delay
                    const sessionId = el.id.replace('timer-', '');
                    const card = el.closest('.running-class-card');
                    if (card && !card.classList.contains('removing')) {
                        card.classList.add('removing');
                        card.style.transition = 'all 0.5s ease';
                        card.style.opacity = '0';
                        card.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            card.remove();
                            // Update active count
                            const countEl = document.getElementById('active-count');
                            if (countEl) {
                                const current = parseInt(countEl.textContent) || 0;
                                countEl.textContent = Math.max(0, current - 1);
                            }
                            // Check if grid is empty
                            const grid = document.getElementById('active-sessions-grid');
                            const remainingCards = grid ? grid.querySelectorAll('.running-class-card') : [];
                            if (grid && remainingCards.length === 0) {
                                grid.innerHTML = `
                                    <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                                        <i class="fas fa-chalkboard" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                                        <p style="margin: 0; font-size: 1rem;">No classes running at the moment</p>
                                        <p style="margin: 5px 0 0; font-size: 0.85rem; opacity: 0.7;">Teachers can start sessions from their dashboard</p>
                                    </div>
                                `;
                            }
                        }, 500);
                    }
                    return;
                }

                const hours = Math.floor(remaining / 3600);
                const minutes = Math.floor((remaining % 3600) / 60);
                const seconds = remaining % 60;

                el.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                // Change color when less than 10 minutes
                if (remaining < 600) {
                    el.style.color = '#e74c3c';
                } else {
                    el.style.color = '#27ae60';
                }
            });
        }

        // Start timer updates
        updateSessionTimers();
        setInterval(updateSessionTimers, 1000);

        // Auto-refresh REMOVED - was causing pages to reload unexpectedly
        // Use the Refresh button or navigate back to refresh data instead

        // Dark mode toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('theme-icon');
            if (document.body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                localStorage.setItem('darkMode', 'true');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                localStorage.setItem('darkMode', 'false');
            }
        }

        // Load saved theme
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-icon').classList.remove('fa-moon');
            document.getElementById('theme-icon').classList.add('fa-sun');
        }
    </script>
</body>

</html>